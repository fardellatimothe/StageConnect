{% extends 'base.twig' %}

{% block title %}Mon compte - StageConnect{% endblock %}

{% block style %}
    <link rel="stylesheet" href="../../static/styles/user-style.css">
{% endblock %}

{% block content %}
    <div class="container">
        <div class="container">
            <div class="sidebar">
                <ul>
                     <li data-section="settings" onclick="showSection('settings')">Mon compte</li>
                    <li data-section="security" onclick="showSection('security')">Confidentialité</li>
                    <li data-section="whishlist" onclick="showSection('whishlist')">Whishlist</li>
                    <li data-section="candidacy" onclick="showSection('candidacy')">Mes offres</li>
                    {% if user.Id_Role == 3 %}
                        <li data-section="students-stats" onclick="showSection('stats')">Statistiques</li>
                        <li data-section="evaluation" onclick="showSection('evaluation')">Évaluation</li>
                        <li data-section="companies-management" onclick="showSection('companies-management')">Gestion des entreprises</li>
                        <li data-section="offers-management" onclick="showSection('offers-management')">Gestion des offres</li>
                        <li data-section="students-management" onclick="showSection('students-management')">Gestion des étudiants</li>
                        <li data-section="pilots-management" onclick="showSection('pilots-management')">Gestion des pilotes</li>
                        <li data-section="students-candidacy" onclick="showSection('students-candidacy')">Gestion des candidatures étudiants</li>
                    {% elseif user.Id_Role == 2 %}
                        <li data-section="evaluation" onclick="showSection('evaluation')">Évaluation</li>
                        <li data-section="students-management" onclick="showSection('students-management')">Gestion des étudiants</li>
                    {% endif %}
                </ul>
            </div>
        </div>
        <!-- Comptes étudiants -->
        <div class="content">
            <!--Section régales du comptes-->
            <div id="settings" class="content-section active">
                <h2>Mon Profil</h2>
                {% if user.cv_path %}
                    <div class="div-pdp">
                        <img class="pdp-user" src="images/Shadow-steam.webp" alt="Photo de profil">
                        <div class="cv-input-container">
                            <label for="cv-upload" class="cv-input-label">
                                <i class="fas fa-upload"></i> Modifier votre cv
                            </label>
                            <input type="file" id="cv-upload" class="cv-input" accept=".pdf,.doc,.docx">
                        </div>
                        
                        <!-- Afficher un aperçu du CV téléchargé -->
                        <div class="cv-preview" id="cv-preview">
                            <a href="../../{{ user.cv_path }}" id="cv-link" target="_blank">
                                <i class="fas fa-file-download"></i> Voir votre CV
                            </a>
                        </div>
                    </div>
                {% else %}
                    <div class="div-pdp">
                        <img class="pdp-user" src="images/Shadow-steam.webp" alt="Photo de profil">
                        <div class="cv-input-container">
                            <label for="cv-upload" class="cv-input-label">
                                <i class="fas fa-upload"></i> Ajouter un CV
                            </label>
                            <input type="file" id="cv-upload" class="cv-input" accept=".pdf,.doc,.docx">
                        </div>
                    </div>
                {% endif %}

                <div class="separator"></div>
                
                <div class="div-info">
                    <div class="info-title">Prénom</div>
                    <div contenteditable="true">{{user.name}}</div>
                </div>
                
                <div class="div-info">
                    <div class="info-title">Nom</div>
                    <div contenteditable="true">{{user.surname}}</div>
                </div>

                <div class="separator"></div>
                
                <div class="div-para">Promotion : <span>nom de la promotion</span></div>
                <div class="div-para">Pilote de promotion : <span>nom/prenom du pilote de la promotion</span></div>

                <div class="separator"></div>

                <div class="div-logout">
                    <button class="buttonLogout" onclick="window.location.href='/logout'">
                        <div class="signLogout">
                            <svg viewBox="0 0 512 512">
                                <path d="M377.9 105.9L500.7 228.7c7.2 7.2 11.3 17.1 11.3 27.3s-4.1 20.1-11.3 27.3L377.9 406.1c-6.4 6.4-15 9.9-24 9.9c-18.7 0-33.9-15.2-33.9-33.9l0-62.1-128 0c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32l128 0 0-62.1c0-18.7 15.2-33.9 33.9-33.9c9 0 17.6 3.6 24 9.9zM160 96L96 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-64 0c-53 0-96-43-96-96L0 128C0 75 43 32 96 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32z"></path>
                            </svg>
                        </div>
                        <div class="textLogout">Se déconnecter</div>
                    </button>
                </div>
            </div>

            <!--Section sécurity-->
            <div id="security" class="content-section">
                <h2>Ma sécurité</h2>

                <div class="div-info">
                    <div class="info-title">Numéro de téléphone</div>
                    <div contenteditable="true">{{user.phone}}</div>
                </div>
                
                <div class="div-info">
                    <div class="info-title">Email</div>
                    <div contenteditable="true">{{user.mail}}</div>
                </div>
            </div>

            <!-- Section statistiques du compte -->
            <div id="stats" class="content-section">
                <h2>Statistiques de recherches</h2>
                
                <!-- Statistiques globales -->
                <div class="stats-summary">
                    <p><strong>Nombre d'offres candidatées :</strong> {{ candidateCount }}</p>
                    <p><strong>Nombre d'avis laissés :</strong> {{ reviewCount }}</p>
                </div>
                
                <!-- Dernière offre candidatée -->
                <div class="latest-offer">
                    <h3>Dernière offre candidatée</h3>
                    {% if lastCandidate is defined and lastCandidate %}
                        <p>
                            <strong>{{ lastCandidate.title }}</strong>
                            <br>
                            Publiée le {{ lastCandidate.publication_date|date('d/m/Y') }}
                        </p>
                        <a href="/search?q={{lastCandidate.title ?? ''}}&l={{lastCandidate.localisation ?? ''}}&s={{lastCandidate.sector ?? ''}}&d={{lastCandidate.duration ?? ''}}&t={{lastCandidate.type ?? ''}}&n={{lastCandidate.studieslevel ?? ''}}">Voir l'offre</a>
                    {% else %}
                        <p>Aucune offre candidatée.</p>
                    {% endif %}
                </div>
                
                <!-- Dernier avis laissé -->
                <div class="latest-review">
                    <h3>Dernier avis laissé</h3>
                    {% if lastReview is defined and lastReview %}
                        <p>
                            "{{ lastReview.comment }}" <br>
                            Note : {{ lastReview.rating }} / 5 <br>
                            Le {{ lastReview.date|date('d/m/Y') }}
                        </p>
                    {% else %}
                        <p>Aucun avis laissé.</p>
                    {% endif %}
                </div>
            </div>

            <!--Section gestion des offres/candidatures-->
            <div id="candidacy" class="content-section">
                <h2>Gestion des offres</h2>

                <div class="div-candidacy">
                    <section class="section-offrer">
                        <h4>Offre Candidaté 1</h4>
                    </section>
                    <section class="section-offrer">
                        <h4>Offre Candidaté 2</h4>
                    </section>
                    <section class="section-offrer">
                        <h4>Offre Candidaté 3</h4>
                    </section>
                </div>
            </div>

            <!--Section Whishlist-->
            <div id="whishlist" class="content-section">
                <h2>Votre Whishlist</h2>

                <div class="div-candidacy">
                    <section class="section-offrer">
                        <h4>Offre 1</h4>
                    </section>
                    <section class="section-offrer">
                        <h4>Offre 2</h4>
                    </section>
                    <section class="section-offrer">
                        <h4>Offre 3</h4>
                    </section>
                </div>
            </div>


            <!--Section réglages du comptes (Pilote de Promotions)-->
            <div id="stats(tuteur)" class="content-section">
                <h2>Mon Profil</h2>

                <div class="div-pdp">
                    <img class="pdp-user" src="images/Shadow-steam.webp" alt="Photo de profil">
                    <input id="btnPdpModify" class="pdp-modify" type="file">
                </div>

                <div class="separator"></div>
                
                <div class="div-info">
                    <div class="info-title">Prénom</div>
                    <div contenteditable="true">Antonin</div>
                </div>
                
                <div class="div-info">
                    <div class="info-title">Nom</div>
                    <div contenteditable="true">Mignot</div>
                </div>

                <div class="separator"></div>
                
                <div class="div-para">Promotion que vous pilotez : <span>CPI A2, FISA A3</span></div>

                <div class="separator"></div>

                <div class="div-logout">
                    <button class="buttonLogout">
                        <div class="signLogout"><svg viewBox="0 0 512 512"><path d="M377.9 105.9L500.7 228.7c7.2 7.2 11.3 17.1 11.3 27.3s-4.1 20.1-11.3 27.3L377.9 406.1c-6.4 6.4-15 9.9-24 9.9c-18.7 0-33.9-15.2-33.9-33.9l0-62.1-128 0c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32l128 0 0-62.1c0-18.7 15.2-33.9 33.9-33.9c9 0 17.6 3.6 24 9.9zM160 96L96 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-64 0c-53 0-96-43-96-96L0 128C0 75 43 32 96 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32z"></path></svg></div>
                        <div class="textLogout">Se déconnecter</div>
                    </button>
                </div>
            </div>

            <!-- Section gestion des pilotes -->
            <div id="pilots-management" class="content-section">
                <h2>Gestion des pilotes</h2>

                <div class="div-pilots">
                    <table class="pilots-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nom</th>
                                <th>Email</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                         {% for tut in tutor %}
                            <tr>
                                <td>{{ tut.Id_Users }}</td>
                                <td>{{ tut.name }} {{ tut.surname }}</td>
                                <td>{{ tut.mail }}</td>
                                <td>
                                    <button class="btn modify-promo" data-id="{{ tut.Id_Users }}">Modifier</button> <!--On peut modifier les promotions dont il est le tuteur-->
                                    <button class="btn delete">Supprimer</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <button class="btn add">Ajouter un pilote</button>
                </div>
            </div>

            <!-- Section gestion des promotions -->
            <div id="promotions-management" class="content-section">
                <h2>Gestion des promotions</h2>

                <div class="div-promotions">
                    <table class="promotions-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nom de la promotion</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                       
                            <tr>
                                <td>1</td>
                                <td>CPI A2</td> <!--Quand on appuie ca retourne vers une page compète avec les étudiants-->
                                <td>
                                    <button class="btn add-student">Ajouter un étudiant</button>
                                    <button class="btn delete">Supprimer</button>
                                </td>
                            </tr>
                            
                            <tr>
                                <td>2</td>
                                <td>FISA A3</td>
                                <td>
                                    <button class="btn add-student">Ajouter un étudiant</button>
                                    <button class="btn delete">Supprimer</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <button class="btn create">Créer une promotion</button>
                </div>
            </div>

            <!-- Section gestion des étudiants -->
            <div id="students-management" class="content-section">
                <h2>Gestion des étudiants</h2>

                <div class="div-students">
                    <table class="students-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nom</th>
                                <th>Email</th>
                                <th>Promotion</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                                <tr>
                                    <td>{{ student.Id_Users }}</td>
                                    <td>{{ student.name }} {{ student.surname }}</td>
                                    <td>{{ student.mail }}</td>
                                    <td>{{ student.Id_Promotion }}</td>
                                    <td>
                                        <button class="btn modify-promo" data-id="{{ student.Id_Users }}">Modifier</button>
                                        <button class="btn block" data-id="{{ student.id }}">Bloquer</button>
                                        <button class="btn delete" data-id="{{ student.id }}">Supprimer</button>
                                    </td>
                                </tr>
                            {% else %}
                                <tr>
                                    <td colspan="5" class="no-data">Aucun étudiant trouvé.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <button id="addStudentButton" class="btn btn-primary">Ajouter un étudiant</button>
                </div>
            </div>
            
            <!-- Section gestion des entreprises -->
            <div id="companies-management" class="content-section">
                <h2>Gestion des entreprises</h2>

                <div class="div-companies">
                    <table class="companies-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nom</th>
                                <th>Email</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for corporations in corporation %}
                            <tr>
                                <td>{{ corporations.Siret }}</td>
                                <td>{{ corporations.name }}</td>
                                <td>{{ corporations.mail }}</td>
                                <td>
                                    <button class="btn block">Bloquer</button>
                                    <button class="btn delete">Supprimer</button>
                                </td>
                            </tr>
                            {% else %}
                                <tr>
                                    <td colspan="5" class="no-data">Aucune entreprise trouvée.</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>

                    <button class="btn add">Ajouter une entreprise</button>
                </div>
            </div>
            
            <!-- Formulaires de modification et création (un seul exemplaire de chaque) -->
            <form method="POST" action="/updateUser" id="updateUserForm" style="display: none;">
                <input type="hidden" name="Id_User" id="formIdUser">
                <input type="text" name="email" id="formEmail" placeholder="Email">
                <input type="text" name="name" id="formName" placeholder="Prénom">
                <input type="text" name="surname" id="formSurname" placeholder="Nom">
                <input type="password" name="password" id="formPassword" placeholder="Mot de passe" value="">
                <input type="text" name="Id_Prom" id="formIdProm" placeholder="Promotion">
                <select name="Id_Role" id="formIdRole">
                    <option value="1">Étudiant</option>
                    <option value="2">Pilote</option>
                </select>
                <button type="submit">Mettre à jour</button>
            </form>

            <form method="POST" action="/createUser" id="createUserForm" style="display: none;">
                <input type="text" name="email" id="createFormEmail" placeholder="Email" required>
                <input type="text" name="name" id="createFormName" placeholder="Prénom" required>
                <input type="text" name="surname" id="createFormSurname" placeholder="Nom" required>
                <input type="password" name="password" id="createFormPassword" placeholder="Mot de passe" required>
                <input type="text" name="Id_Prom" id="createFormIdProm" placeholder="Promotion" required>
                <select name="Id_Role" id="createFormIdRole">
                    <option value="1">Étudiant</option>
                    <option value="2">Pilote</option>
                </select>
                <button type="submit" class="btn btn-success">Créer</button>
            </form>
        </div>
    </div>
    
    <script src="../static/scripts/user-script.js"></script>
{% endblock %}